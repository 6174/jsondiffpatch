<!DOCTYPE html>
<html>
    <head>
        <title>JsonDiffPatch Demo</title>
        <script src="http://code.jquery.com/jquery-1.6.2.js" type="text/javascript">
        </script>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <link rel="stylesheet" href="style.css" type="text/css" media="screen" />
        <!-- START: required libs -->
        <script type='text/javascript' src='../src/jsondiffpatch.js'>
        </script>
        <script type='text/javascript' src='../src/diff_match_patch_uncompressed.js'>
        </script>
        <!-- END: required libs -->
    </head>
    <body>
        <a href='https://github.com/benjamine/JsonDiffPatch' id='fork_me'>
            <img alt='Fork me on GitHub' src='http://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png'>
        </a>
        <h1>JsonDiffPatch Demo</h1>
        <div class="jsontext">
            <div>
                <label for="json1">
                    JSON Original 
                </label>
                <input id="json1pretty" type="button" value="pretty format">
                <textarea id="json1" class="json-input">
                </textarea>
                <span id="json1errormessage" class="jsonerrormessage"></span>
            </div>
            <div>
                <label for="json2">
                    JSON New
                </label>
                <input id="json2pretty" type="button" value="pretty format">
                <textarea id="json2" class="json-input">
                </textarea>
                <span id="json2errormessage" class="jsonerrormessage"></span>
            </div>
        </div>
        <div class="buttons">
            <input id="compare" type="button" value="Compare"><input id="swap" type="button" value="Swap"><input id="clear" type="button" value="Clear">
            <div>
                <input id="live" type="checkbox" checked="checked">
                <label for="live">
                    live
                </label>
            </div>
        </div>
        <div class="results">
            <h2>Visual Diff</h2>
            <div>
                <input id="showunchanged" type="checkbox">
                <label for="showunchanged">
                    Show unchanged values
                </label>
            </div>
            <p class="visualdiff" id="visualdiff">
            </p>
            <h2>JSON Diff</h2>
            <p>
                (<span id="jsondifflength"></span>
                KB)
            </p>
            <textarea id="jsondiff">
            </textarea>
        </div>
        <script type="text/javascript">
            
            var data = {
                name: 'South America',
                summary: "\
                                                                                                                                                            South America (Spanish: América del Sur, Sudamérica or Suramérica; Portuguese: \
                                                                                                                                                            América do Sul; Quechua and Aymara: Urin Awya Yala; Guarani: Ñembyamérika; \
                                                                                                                                                            Dutch: Zuid-Amerika; French: Amérique du Sud) is a continent situated in the \
                                                                                                                                                            Western Hemisphere, mostly in the Southern Hemisphere, with a relatively small \
                                                                                                                                                            portion in the Northern Hemisphere. The continent is also considered a \
                                                                                                                                                            subcontinent of the Americas.[2][3] It is bordered on the west by the Pacific \
                                                                                                                                                            Ocean and on the north and east by the Atlantic Ocean; North America and the \
                                                                                                                                                            Caribbean Sea lie to the northwest. It includes twelve countries: Argentina, \
                                                                                                                                                            Bolivia, Brazil, Chile, Colombia, Ecuador, Guyana, Paraguay, Peru, Suriname, \
                                                                                                                                                            Uruguay, and Venezuela. The South American nations that border the Caribbean \
                                                                                                                                                            Sea—including Colombia, Venezuela, Guyana, Suriname, as well as French Guiana, \
                                                                                                                                                            which is an overseas region of France—are also known as Caribbean South America. \
                                                                                                                                                            \
                                                                                                                                                            South America has an area of 17,840,000 square kilometers (6,890,000 sq mi). \
                                                                                                                                                            Its population as of 2005 has been estimated at more than 371,090,000. South \
                                                                                                                                                            America ranks fourth in area (after Asia, Africa, and North America) and fifth \
                                                                                                                                                            in population (after Asia, Africa, Europe, and North America). The word \
                                                                                                                                                            America was coined in 1507 by cartographers Martin Waldseemüller and Matthias \
                                                                                                                                                            Ringmann, after Amerigo Vespucci, who was the first European to suggest that \
                                                                                                                                                            the lands newly discovered by Europeans were not India, but a New World \
                                                                                                                                                            unknown to Europeans.",
                
                surface: 17840000,
                timezone: [-4, -2],
                demographics: {
                    population: 385742554,
                    largestCities: ["São Paulo", "Buenos Aires", "Rio de Janeiro", "Lima", "Bogotá"]
                },
                languages: ["spanish", "portuguese", "english", "dutch", "french", "quechua", "guaraní", "aimara", "mapudungun"],
                countries: [{
                    name: "Argentina",
                    capital: "Buenos Aires",
                    independence: new Date(1816, 6, 9),
                    unasur: true
                }, {
                    name: "Bolivia",
                    capital: "La Paz",
                    independence: new Date(1825, 7, 6),
                    unasur: true
                }, {
                    name: "Brazil",
                    capital: "Brasilia",
                    independence: new Date(1822, 8, 7),
                    unasur: true
                }, {
                    name: "Chile",
                    capital: "Santiago",
                    independence: new Date(1818, 1, 12),
                    unasur: true
                }, {
                    name: "Colombia",
                    capital: "Bogotá",
                    independence: new Date(1810, 6, 20),
                    unasur: true
                }, {
                    name: "Ecuador",
                    capital: "Quito",
                    independence: new Date(1809, 7, 10),
                    unasur: true
                }, {
                    name: "Guyana",
                    capital: "Georgetown",
                    independence: new Date(1966, 4, 26),
                    unasur: true
                }, {
                    name: "Paraguay",
                    capital: "Asunción",
                    independence: new Date(1811, 4, 14),
                    unasur: true
                }, {
                    name: "Peru",
                    capital: "Lima",
                    independence: new Date(1821, 6, 28),
                    unasur: true
                }, {
                    name: "Suriname",
                    capital: "Paramaribo",
                    independence: new Date(1975, 10, 25),
                    unasur: true
                }, {
                    name: "Uruguay",
                    capital: "Montevideo",
                    independence: new Date(1825, 7, 25),
                    unasur: true
                }, {
                    name: "Venezuela",
                    capital: "Caracas",
                    independence: new Date(1811, 6, 5),
                    unasur: true
                }]
            };
            
            $('#json1').val(JSON.stringify(data));
            
            data.summary = data.summary.replace('Brazil', 'Brasil').replace('also known as', 'a.k.a.');
            data.countries.pop();
            data.countries.pop();
            data.countries[0].capital = 'Rawson';
            data.countries.push({
                name: 'Antártida',
                unasur: false
            });
            delete data.surface;
            data.spanishName = 'Sudamérica';
            data.demographics.population += 2342;
            
            $('#json2').val(JSON.stringify(data));
            
            $(function(){
            
                $('#swap').click(function(){
                    var t = $('#json1').val();
                    $('#json1').val($('#json2').val());
                    $('#json2').val(t);
					compare();
                });
                
                $('#clear').click(function(){
                    $('#json1').val('');
                    $('#json2').val('');
                });
                
                $('#showunchanged').change(function(){
                    $('.unchanged')[this.checked ? 'slideDown' : 'slideUp']();
                });
                
                var objectToHtml = function(desc, o){
                    var container = document.createElement('div');
                    if (desc) {
                        if (o instanceof Array) {
                        
                        }
                        var descspan = document.createElement('span');
                        descspan.innerText = desc + (o instanceof Array ? ' (array)' : '');
                        descspan.setAttribute('class', 'property-name');
                        container.appendChild(descspan);
                    }
                    
                    if (typeof o == 'object') {
                        // a node (object or array)
                        var ul = document.createElement('ul');
                        
                        for (var prop in o) {
                            if (o.hasOwnProperty(prop)) {
                                var li = document.createElement('li');
                                li.appendChild(objectToHtml(prop, o[prop]));
                                ul.appendChild(li);
                            }
                        }
                        if (ul.childNodes.length > 0) {
                            container.appendChild(ul);
                        }
                    }
                    else {
                        var elem = document.createElement('p');
                        // unchanged
                        elem.innerText = JSON.stringify(o);
                        container.appendChild(elem);
                    }
                    return container;
                }
                
                var diffToHtml = function(desc, o, n, d){
                    var container = document.createElement('div');
                    var descspan = document.createElement('span');
                    descspan.innerText = desc + (n instanceof Array ? ' (array)' : '');
                    descspan.setAttribute('class', 'property-name');
                    container.appendChild(descspan);
                    if (d instanceof Array) {
                        // a added/modified/removed value
                        var elem = document.createElement('p');
                        if (d.length === 1) {
                            // added
                            container.setAttribute('class', 'added');
                            elem.appendChild(objectToHtml(null, d[0]));
                        }
                        else 
                            if (d.length == 2) {
                                // modified
                                container.setAttribute('class', 'modified');
                                var d1 = document.createElement('div');
                                d1.setAttribute('class', 'modified-original');
                                d1.appendChild(objectToHtml(null, d[0]));
                                var d2 = document.createElement('div');
                                d2.setAttribute('class', 'modified-new');
                                d2.appendChild(objectToHtml(null, d[1]));
                                elem.appendChild(d1);
                                elem.appendChild(d2);
                            }
                            else 
                                if (d[2] === 0) {
                                    // deleted
                                    container.setAttribute('class', 'deleted');
                                    elem.appendChild(objectToHtml(null, d[0]));
                                }
                                else 
                                    if (d[2] === 2) {
                                        // text diff
                                        container.setAttribute('class', 'textdiff');
                                        var lines = d[0].split('\n'), lcount = lines.length;
                                        
                                        for (var i = 0; i < lcount; i++) {
                                            var lelem = document.createElement('span');
                                            if (lines[i][0] === '+') {
                                                lelem.setAttribute('class', 'added');
                                            }
                                            else 
                                                if (lines[i][0] === '-') {
                                                    lelem.setAttribute('class', 'deleted');
                                                }
                                                else 
                                                    if (lines[i][0] === '@') {
                                                        lelem.setAttribute('class', 'header');
                                                    }
                                            
                                            lelem.innerText = lines[i].substring(lines[i][0] !== '@' ? 1 : 0);
                                            elem.appendChild(lelem);
                                        }
                                    }
                        
                        container.appendChild(elem);
                    }
                    else {
                        // a node (object or array)
                        var ul = document.createElement('ul');
                        
                        // only members in diff (skip unchanged members)
                        container.setAttribute('class', d._t === 'a' ? 'array' : 'object');
                        for (var prop in d) {
                            if (d.hasOwnProperty(prop) && prop !== '_t') {
                                var li = document.createElement('li');
                                li.appendChild(diffToHtml(prop, o[prop], n[prop], d[prop]));
                                ul.appendChild(li);
                            }
                        }
                        
                        // unchanged props
                        if (typeof o == 'object') {
                            for (var prop in o) {
                                if (o.hasOwnProperty(prop) && !d.hasOwnProperty(prop) && prop !== '_t') {
                                    var li = document.createElement('li');
                                    li.setAttribute('class', 'unchanged');
                                    li.appendChild(objectToHtml(prop, o[prop]));
                                    ul.appendChild(li);
                                }
                            }
                        }
                        container.appendChild(ul);
                    }
                    return container;
                }
                
                var compare = function(){
                
                    var json = [];
                    var errors = false;
                    $('#json1,#json2').removeClass('json-error');
                    $('.jsonerrormessage').text('');
                    try {
                        json[0] = JSON.parse($('#json1').val());
                    } 
                    catch (err) {
                        $('#json1').addClass('json-error');
                        $('#json1errormessage').text(err + '');
                        errors = true;
                    }
                    try {
                        json[1] = JSON.parse($('#json2').val());
                    } 
                    catch (err) {
                        $('#json2').addClass('json-error');
                        $('#json2errormessage').text(err + '');
                        errors = true;
                    }
                    
                    if (errors) {
                        $('.results').hide();
                        return;
                    }
                    
                    var d = jsondiffpatch.diff(json[0], json[1]);
                    
                    if (typeof d == 'undefined') {
                        $('#jsondiff').val('');
                        $('#jsondifflength').text('0');
                        $('#visualdiff').empty().text('no diff');
                    }
                    else {
                        $('#jsondiff').val(JSON.stringify(d, null, 2));
                        $('#jsondifflength').text(Math.round(JSON.stringify(d).length / 102.4) / 10.0);
                        $('#visualdiff').empty().append(diffToHtml('root', json[0], json[1], d));
                    }
                    $('.unchanged')[$('#showunchanged').get(0).checked ? 'show' : 'hide']();
                    
                    $('.results').show();
                };
                
                $('#compare').click(compare);
                
                $('.json-input').change(function(){
                    if ($('#live').attr('checked')) {
                        compare();
                    }
                }).keyup(function(){
                    if ($('#live').attr('checked')) {
                        compare();
                    }
                });
                
                $('#live').change(function(){
                    if (this.checked) {
                        compare();
                    }
                    $('#compare').attr('disabled', this.checked ? 'disabled' : null);
                });
                $('#compare').attr('disabled', $('#live').get(0).checked ? 'disabled' : null);
                $('#live').get(0).checked
                
                $('#json1pretty').click(function(){
                    var $json = $('#json1');
                    $json.removeClass('json-error');
                    $('#json1errormessage').text('');
                    try {
                        $json.val(JSON.stringify(JSON.parse($json.val()), null, 2));
                    } 
                    catch (err) {
                        $('#json1errormessage').text(err + '');
                        $json.addClass('json-error');
                        errors = true;
                    }
                });
                
                $('#json2pretty').click(function(){
                    var $json = $('#json2');
                    $json.removeClass('json-error');
                    $('#json2errormessage').text('');
                    try {
                        $json.val(JSON.stringify(JSON.parse($json.val()), null, 2));
                    } 
                    catch (err) {
                        $('#json2errormessage').text(err + '');
                        $json.addClass('json-error');
                        errors = true;
                    }
                });
                
                $('.results').hide();
                
                if ($('#live').get(0).checked) {
                    compare();
                }
            });
        </script>
    </body>
</html>
